{% extends 'annotation_tool/base.html' %}
{% load rest_framework %}
{% load staticfiles %}

{% block title %}Classes{% endblock %}

{% block header %}Classes{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/jquery-ui.min.js' %}"></script>
    <script src="{% static 'js/bootstrap-tokenfield.min.js' %}"></script>
    <script src="{% static 'js/bootstrap-colorpicker.min.js' %}"></script>
    <script>
        var TAGS_NAMES = {% if tags_names %}'{{ tags_names }}'.split(','){% else %}[]{% endif %};
        var OPEN_MODAL = {% if errors %}true{% else %}false{% endif %};
    </script>
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/jquery-ui.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/bootstrap-tokenfield.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/bootstrap-colorpicker.min.css' %}">
{% endblock %}

{% block body_block %}
    <div id="add-modal" class="modal fade" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Add class</h4>
                </div>
                <form action="" method="post">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-8 col-md-offset-2">
                                {% csrf_token %}
                                {% render_form serializer %}
                                {% if errors and errors.non_field_errors %}
                                    <div class="alert alert-danger">
                                        {{ errors.non_field_errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <input type="hidden" id="delete-url">

                        <input type="submit" value="Create new class" class="btn btn-success"/>

                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <button class="btn btn-success" id="add-item-button" data-toggle="modal" data-target="#add-modal">Add class</button>

    {% if query_data %}

        <table class="table table-striped table-bordered sortable" style="width: auto;">
            <tr>
                <th>ID</th>
                <th>Class name</th>
                <th>Root class</th>
            </tr>
            {% for class in query_data %}
                {% if class.root.name == 'root' and class.name != 'root' %}

                    <div class='parentButton'>
                        <button
                                data-class-id="{{ class.id }}"
                                data-class-name="{{ class.name }}"
                                data-class-root="{{ class.root }}"
                                class="btn btn-primary btn_mark"
                                type="button"
                        >
                            {{ class.name }}
                        </button>
                        <button data-delete-url="{% url 'class' class.id %}" class="btn btn-danger delete-item"
                                data-toggle="modal" data-target="#delete-modal">X
                        </button>
                        <button type="button" data-class-state="show" class="showOrHideChilds btn btn-default"><span class="caret"></span></button>

                        <div class="childs">

                        </div>
                    </div>
                {% endif%}

                {% if class.name != 'root' %}
                    <tr>
                        <td>{{ class.id }}</td>
                        <td>{{ class.name }}</td>
                        <td>{{ class.root }}</td>
                        <td>
                            <button data-delete-url="{% url 'class' class.id %}" class="btn btn-danger delete-item"
                                    data-toggle="modal" data-target="#delete-modal">Delete
                            </button>
                        </td>
                    </tr>
                {%endif %}
            {% endfor %}
        </table>
        <p>Displaying {{ query_data|length|add:"-1" }} classes ordered by ID.</p>
        {% include 'annotation_tool/_modal_delete.html' with text='Are you sure you want to delete this class?' %}
    {% else %}
        <p>No data is available.</p>
    {% endif %}


    <script type="text/javascript">


        /************* For Print Class in Tree ***********/
        let classes_json = {{JSON_CLASSES|safe}};

        const classes_filtered = classes_json.map(Class => {
            let obj = {};
            obj.id = Class.pk;
            obj.name = Class.fields.name;
            obj.root = Class.fields.root;
            return obj;
        });


        {#const btns = () => $('.btn_mark').on('click', function ( e ) { chargeChild(e.target) });#}
        {#btns();#}

        {#   const recreateButtonsEvents = () => {#}
        {#       $('.btn_mark').off('click');#}
        {#       $('.showOrHideChilds').off('click');#}

        {#       btns();#}
        {#       eventShowOrHideChilds();#}
        {#   };#}

        function findDirectChilds(father){
            return classes_filtered.filter(cclass => {if (cclass.root == father) return cclass })
        }

        function chargeChild(father){
            const childs = findDirectChilds(father.dataset['classId']);
            const childsDOM =  $(father).parent().find('div.childs li');

            if(childs.length > 0 && childsDOM.length === 0) {

                var UL = $('<ul></ul>');

                const childsToInsert = childs.map(child => {

                    var plus = findDirectChilds(child.id).length > 0 ?
                        '<button type="button" data-class-state="show" class="showOrHideChilds btn btn-default"><span class="caret"></span></button>': '';

                    return `<li>
                              <span>
                                   <button
                                           data-class-id="${child.id}"
                                           data-class-color="${child.color}"
                                           data-class-name="${child.name}"
                                           class="btn btn-primary btn_mark"
                                           type="button"
                                   >
                                       ${child.name}
                                       <span class="shortcut">(${child.shortcut})</span>
                                   </button>`+plus+`
                               <div class='childs'></div>
                               </span>
                           </li>`;
                });

                childsToInsert.forEach(function (htmlChild) {
                    UL.append($(htmlChild))
                });

                $(father).parent().find('div.childs').html(UL);
                recreateButtonsEvents();

                switchBtnShowOrHide(father.nextSibling);
            }
        }

        {#   function toHideChild(btn){#}
        {#       $(btn).parent().find('> div.childs').html('');#}
        {#   }#}
        {##}
        {#   function toShowChild(btn){#}
        {#       chargeChild($(btn).parent().find('> button.btn_mark')[0]);#}
        {#   }#}
        {##}
        {#   function switchBtnShowOrHide(btn){#}
        {##}
        {#       if(btn.dataset['classState'] === 'hide') {#}
        {#           btn.dataset['classState'] = 'show';#}
        {#           btn.classList.remove('fa-rotate-180');#}
        {#       }#}
        {##}
        {#       else{#}
        {#           btn.dataset['classState']='hide';#}
        {#           btn.classList.add('fa-rotate-180');#}
        {#       }#}
        {#   }#}
        {##}
        {#   function showOrHideChilds(e){#}
        {##}
        {#       var btn = e.target;#}
        {##}
        {#       if(e.target.tagName==='SPAN')#}
        {#           btn=e.target.parentNode;#}
        {##}
        {#       if (btn.dataset['classState']==='hide'){#}
        {#           toHideChild(btn);#}
        {#           switchBtnShowOrHide(btn);#}
        {#       }#}
        {#       else{#}
        {#           toShowChild(btn);#}
        {#       }#}
        {##}
        {#   }#}
        {##}
        {#   var eventShowOrHideChilds = () =>$('.showOrHideChilds').on('click',function(e){#}
        {#       showOrHideChilds(e);#}
        {#   });eventShowOrHideChilds();#}

    </script>

{% endblock %}
